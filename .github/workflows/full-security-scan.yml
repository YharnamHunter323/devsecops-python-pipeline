name: Full Security Scan

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *' # nightly at 02:00 UTC

permissions:
  contents: read
  security-events: write

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: full-scan


  trivy_scan:
    name: Trivy Image Scan
    runs-on: ubuntu-latest
    needs: codeql
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t demo-app:latest .

      - name: Run Trivy image scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: demo-app:latest
          format: json
          output: trivy-report.json
          exit-code: 0

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json


  dast:
    name: OWASP ZAP DAST
    runs-on: ubuntu-latest
    needs: trivy_scan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start application stack
        run: |
          docker compose up -d
          timeout=60
          until curl -s http://localhost:8080 >/dev/null || [ $timeout -le 0 ]; do
            sleep 1
            timeout=$((timeout-1))
          done

      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: http://localhost:8080
          rules_file_name: zap.yaml
          cmd_options: "-a"

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            zap_report.html
            zap_report.json


  aggregate:
    name: Aggregate Security Reports
    runs-on: ubuntu-latest
    needs: [codeql, trivy_scan, dast]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Trivy report
        uses: actions/download-artifact@v4
        with:
          name: trivy-report

      - name: Download ZAP report
        uses: actions/download-artifact@v4
        with:
          name: zap-report

      - name: Generate aggregated markdown report
        run: |
          python3 .github/scripts/report-aggregate.py \
            --trivy trivy-report.json \
            --zapprobe zap_report.json \
            --output reports/security-summary.md || true

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: full-security-report
          path: reports/security-summary.md
